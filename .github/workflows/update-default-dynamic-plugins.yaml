name: Update Dynamic Plugins Default Config

on:
  # Run weekly on Mondays at 2 AM UTC
  schedule:
    - cron: '0 2 * * 1'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      image:
        description: 'Catalog index image (e.g., quay.io/rhdh/plugin-catalog-index:latest)'
        required: false
        default: 'quay.io/rhdh/plugin-catalog-index:latest'

jobs:
  update-default-plugins:
    name: Update dynamic-plugins.default.yaml
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract dynamic-plugins.default.yaml from catalog-index
        env:
          IMAGE: ${{ github.event.inputs.image || 'quay.io/rhdh/plugin-catalog-index:latest' }}
        run: |
          echo "Extracting from image: ${IMAGE}"
          ./hack/update-default-dynamic-plugins.sh

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet config/profile/rhdh/default-config/default-dynamic-plugins.yaml; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected in default-dynamic-plugins.yaml"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected in default-dynamic-plugins.yaml"

            # Show diff summary
            echo "Diff summary:"
            git diff --stat config/profile/rhdh/default-config/default-dynamic-plugins.yaml
          fi

      - name: Get catalog-index image digest
        id: get_digest
        if: steps.check_changes.outputs.changed == 'true'
        env:
          IMAGE: ${{ github.event.inputs.image || 'quay.io/rhdh/plugin-catalog-index:latest' }}
        run: |
          DIGEST=$(docker inspect --format='{{.RepoDigests}}' ${IMAGE} | grep -oP 'sha256:[a-f0-9]+' | head -1 || echo "unknown")
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
          echo "Image digest: ${DIGEST}"

      - name: Close outdated update PRs
        if: steps.check_changes.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find and close any open PRs for catalog-index updates
          echo "Checking for existing update PRs..."
          OLD_PRS=$(gh pr list --head update-dynamic-plugins-default --state open --json number,title --jq '.[] | "\(.number) \(.title)"')

          if [ -n "$OLD_PRS" ]; then
            echo "Found existing PR(s), closing as outdated:"
            echo "$OLD_PRS"

            gh pr list --head update-dynamic-plugins-default --state open --json number --jq '.[].number' | while read pr_num; do
              COMMENT_BODY="‚ö†Ô∏è **Closing outdated PR**

              This PR has been superseded by a newer catalog-index update.

              - Superseded by: Workflow run #${{ github.run_number }}
              - New source: \`${{ github.event.inputs.image || 'quay.io/rhdh/plugin-catalog-index:latest' }}\`

              A new PR will be created with the latest catalog-index state."

              gh pr close "$pr_num" --comment "$COMMENT_BODY"
              echo "Closed PR #${pr_num}"
            done
          else
            echo "No existing update PRs found"
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Update default-dynamic-plugins.yaml from catalog-index

            Source: ${{ github.event.inputs.image || 'quay.io/rhdh/plugin-catalog-index:latest' }}
            Digest: ${{ steps.get_digest.outputs.digest }}
          branch: update-dynamic-plugins-default
          delete-branch: true
          title: 'chore: Update default-dynamic-plugins ConfigMap from catalog-index'
          body: |
            ## Summary

            This PR updates `config/profile/rhdh/default-config/default-dynamic-plugins.yaml` ConfigMap from the latest catalog-index image.

            **Source Image:** `${{ github.event.inputs.image || 'quay.io/rhdh/plugin-catalog-index:latest' }}`
            **Digest:** `${{ steps.get_digest.outputs.digest }}`

            ## Changes

            The default dynamic plugins configuration has been updated to match the latest version from the catalog-index.

            ```diff
            ${{ steps.check_changes.outputs.diff }}
            ```

            ## Testing

            - [ ] Verify the updated plugins configuration is valid YAML
            - [ ] Check that no unintended plugins were added/removed
            - [ ] Test with `make run` locally

            ---

            ü§ñ Auto-generated by [update-default-plugins workflow](.github/workflows/update-catalog-index.yaml)
          labels: |
            automation
            dependencies
          assignees: ${{ github.actor }}

      - name: Summary
        if: steps.check_changes.outputs.changed == 'false'
        run: |
          echo "‚úÖ No changes detected - default-dynamic-plugins.yaml is up to date"
          echo ""
          echo "Source image: ${{ github.event.inputs.image || 'quay.io/rhdh/plugin-catalog-index:latest' }}"
