name: OpenShift Integration Tests (Kind + OpenShift APIs)

on:
  # Run on schedule (nightly)
  schedule:
    - cron: '0 2 * * *'  # 2 AM UTC daily

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      profile:
        description: 'Profile to test (rhdh, backstage.io)'
        required: false
        default: 'rhdh'
      skip_olm:
        description: 'Skip OLM installation (OLM installed by default)'
        required: false
        type: boolean
        default: false

  # Temporary: trigger on push to test the workflow
  push:
    branches:
      - microshift-tests

concurrency:
  group: openshift-tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  openshift-test:
    name: Test OpenShift Features
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: Create Kind cluster
        uses: helm/kind-action@a1b0e391336a6ee6713a0583f8c6240d70863de3 # v1.12.0
        with:
          cluster_name: openshift-test-cluster
          ignore_failed_clean: true

      - name: Install OpenShift Route API
        run: |
          # Install OpenShift Route CRD to enable testing Route functionality
          echo "Installing OpenShift Route API..."
          kubectl apply -f https://raw.githubusercontent.com/openshift/router/main/deploy/route_crd.yaml

          # Verify Route API is available
          kubectl get crd routes.route.openshift.io

          echo ""
          echo "=== Cluster Ready ==="
          kubectl get nodes
          kubectl cluster-info

      - name: Install OLM
        if: github.event.inputs.skip_olm != 'true'
        run: |
          OLM_VERSION="${OLM_VERSION:-v0.28.0}"

          echo "Installing OLM ${OLM_VERSION}..."
          # Use server-side apply to avoid "annotations too long" error
          # See: https://github.com/operator-framework/operator-lifecycle-manager/issues/2778
          kubectl apply --server-side --force-conflicts -f "https://github.com/operator-framework/operator-lifecycle-manager/releases/download/${OLM_VERSION}/crds.yaml"
          sleep 5
          kubectl apply -f "https://github.com/operator-framework/operator-lifecycle-manager/releases/download/${OLM_VERSION}/olm.yaml"

          echo "Waiting for OLM to be ready..."
          kubectl wait --for=condition=Available --timeout=300s deployment/olm-operator -n olm
          kubectl wait --for=condition=Available --timeout=300s deployment/catalog-operator -n olm

          echo ""
          echo "=== OLM Pods ==="
          kubectl get pods -n olm

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version-file: 'go.mod'

      - name: Build and deploy operator
        run: |
          # Generate manifests and code
          make manifests generate

          # Build operator image
          make image-build IMG=localhost/operator:test

          # Deploy operator (installs CRDs, creates deployment, RBAC, etc.)
          make deploy IMG=localhost/operator:test PROFILE=${{ github.event.inputs.profile || 'rhdh' }}

          # Wait for operator deployment to be ready
          kubectl wait --for=condition=Available --timeout=300s \
            deployment/backstage-controller-manager -n backstage-system

          echo "=== Operator pods ==="
          kubectl get pods -n backstage-system

      - name: Run integration tests
        run: |
          # Run all integration tests (including OpenShift-specific ones)
          # since we're on MicroShift (OpenShift platform)
          make integration-test \
            PROFILE=${{ github.event.inputs.profile || 'rhdh' }} \
            USE_EXISTING_CLUSTER=true \
            USE_EXISTING_CONTROLLER=true

      - name: Run OLM deployment tests
        if: success() && github.event.inputs.skip_olm != 'true'
        run: |
          # Undeploy the direct deployment before testing OLM
          make undeploy

          # Test OLM deployment mode
          make test-e2e BACKSTAGE_OPERATOR_TEST_MODE=olm

      - name: Collect diagnostics on failure
        if: failure()
        run: |
          echo "=== Cluster Info ==="
          kubectl get nodes -o wide || true
          kubectl get pods -A || true

          echo ""
          echo "=== Operator Logs ==="
          kubectl logs -n backstage-system deployment/backstage-controller-manager --all-containers --tail=200 2>/dev/null || echo "No operator logs available"

          echo ""
          echo "=== Backstage Resources ==="
          kubectl get backstage -A -o yaml 2>/dev/null || true

          echo ""
          echo "=== Routes ==="
          kubectl get routes -A 2>/dev/null || true

          echo ""
          echo "=== Recent Events ==="
          kubectl get events -A --sort-by='.lastTimestamp' | tail -50 || true

          # Save operator logs to file for upload
          kubectl logs -n backstage-system deployment/backstage-controller-manager --all-containers --tail=500 > /tmp/operator.log 2>/dev/null || true

      - name: Cleanup
        if: always()
        run: |
          # Cleanup operator deployments (both direct and OLM)
          make undeploy || true
          make undeploy-olm || true

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: openshift-test-logs
          path: /tmp/operator.log
          retention-days: 7
          if-no-files-found: ignore
